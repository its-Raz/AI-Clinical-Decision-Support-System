"""
backend/api.py â€” FastAPI HTTP API for the Autonomous Clinical System.

Endpoints:
    GET  /api/team_info           â†’ team metadata
    GET  /api/agent_info          â†’ agent description, prompts, examples
    GET  /api/model_architecture  â†’ PNG architecture diagram
    POST /api/execute             â†’ run the full pipeline, return response + steps

Run with:
    uvicorn backend.api:app --host 0.0.0.0 --port 8000 --reload

Install dependencies if needed:
    pip install fastapi uvicorn matplotlib
"""

import sys
import os
import logging

sys.path.insert(0, os.path.abspath(os.path.join(os.path.dirname(__file__), "..")))

from fastapi import FastAPI, HTTPException
from fastapi.responses import JSONResponse, Response
from pydantic import BaseModel

from backend.main import (
    initialize,
    route_request,
    build_blood_test_state,
    build_evidence_state,
    execute_pipeline,
)
from backend.supabase.supabase_client import get_patients_summary

log = logging.getLogger(__name__)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Helpers â€” step extraction
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

def _build_steps_from_state(
    route_result: dict,
    user_prompt:  str,
    final_state:  dict,
) -> list[dict]:
    """
    Build the ordered step list for the API response.

    Every node (manager_node, specialist agents, deliver_node) writes its
    own step(s) directly into state["steps"] during execution via the
    operator.add reducer â€” so order is always guaranteed by execution order.

    This function simply:
      1. Prepends the SemanticRouter step (runs before the graph)
      2. Appends the pre-built graph steps from state["steps"]

    No message parsing, no regex, no fallbacks needed.
    """
    # â”€â”€ Step 1: SemanticRouter â€” always first, runs before the graph â”€â”€â”€â”€â”€â”€
    router_step = {
        "module":   "Semantic Router",
        "prompt":   user_prompt,
        "response": (
            f"proposed_category={route_result.get('category')} | "
            f"score={route_result.get('score', 0):.4f} | "
            f"confidence={route_result.get('confidence')} | "
            f"passed={route_result.get('passed')} | "
            f"all_scores={route_result.get('all_scores', {})}"
        ),
    }

    # â”€â”€ Steps 2-N: read directly from state, written by each node â”€â”€â”€â”€â”€â”€â”€â”€
    # Guaranteed order: manager_node â†’ specialist â†’ deliver_node
    # Tool calls are included because each node wrote them at execution time.
    graph_steps = final_state.get("steps", [])

    return [router_step] + graph_steps

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# App initialisation
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

app = FastAPI(
    title="Autonomous Clinical System API",
    description="Multi-agent clinical AI: semantic routing, LLM judge, specialist agents.",
    version="1.0.0",
)


@app.on_event("startup")
async def startup_event():
    """
    Build the semantic router index and ManagerAgent graph once at server
    startup so the first POST /api/execute request is not slowed down.
    """
    print("ðŸš€ [api.py] Running startup initialisation â€¦")
    initialize()
    print("âœ… [api.py] Ready.")


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Request / Response models
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

class ExecuteRequest(BaseModel):
    prompt: str





# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# A)  GET /api/team_info
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

@app.get("/api/team_info")
async def team_info():
    """Return student details and team metadata."""
    return JSONResponse(content={
        "group_batch_order_number": "1",   # â† e.g. "2_5"
        "team_name": "Shalev,Anat and Raz",                    # â† your team name
        "students": [
            {"name": "Anat Lorman", "email": "lormana@campus.techion.ac.il"},
            {"name": "Shalev Hermon", "email": "shalevhermon@campus.techion.ac.il"},
            {"name": "Raz Biton", "email": "raz.biton@campus.techion.ac.il"},
        ],
    })


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# B)  GET /api/agent_info
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

@app.get("/api/agent_info")
async def agent_info():
    """
    Return agent description, purpose, prompt template, and worked examples.

    âš ï¸  Replace the full_response and steps values in prompt_examples with
    REAL outputs from your system. Run each prompt through POST /api/execute
    and paste the actual response and steps back here.
    """
    return JSONResponse(content={
        "description": (
        "The Autonomous Clinical System is a multi-agent AI platform that processes "
        "natural-language medical requests. The pipeline begins with a SemanticRouter "
        "(using OpenAI embeddings and cosine similarity) for fast intent detection. "
        "This is followed by an LLM-based ManagerAgent/Judge that evaluates and "
        "definitively accepts or overrides the routing decision using the judge_decision "
        "tool. The request is then dispatched to the appropriate specialist agent: "
        "BloodTestAnalyst, SkinCareAnalyst, or EvidenceAnalyst. Finally, the clinical "
        "insights are reshaped into a clear, patient-friendly report by the DeliverNode. "
        "API LIMITATIONS: Because this `/api/execute` endpoint accepts only text prompts, "
        "the BloodTestAnalyst will consistently analyze the most recent lab results for "
        "demo patient 'P001', and the SkinCareAnalyst will continuously analyze a "
        "pre-loaded, static demo image of a skin lesion. Selecting different patients "
        "or uploading custom images cannot be done through the API; users must interact "
        "with the full web application interface for these features."
    ),

        "purpose": (
            "To autonomously triage and respond to patient medical queries in a safe, "
            "empathetic, and clinically grounded way. The system's workflow is orchestrated "
            "by the Manager Agent, which acts as the central director ensuring requests are "
            "safely routed to the correct specialist. The specialist purposes are as follows: "
            "1) Blood Test Analyst: Cross-references patient lab results with their medical "
            "history and standard reference ranges to provide clinical interpretations. "
            "2) Skin Care Analyst: Utilizes computer vision models to evaluate images of skin "
            "lesions for potential dermatological concerns. "
            "3) Evidence Analyst: Leverages a RAG system connected to trusted medical "
            "databases to research and answer general medical Q&A and symptom inquiries."
        ),
        "prompt_template": {
            "template": "Can you explain my recent blood test results?"
        },
        "prompt_examples": [
            # Example 1 - blood test
            {
                "prompt": "Can you explain my blood test results?",
                "full_response": "Hi! Your latest blood test results have arrived.\n\n| Test | Result | Reference range | Flag |\n| Glucose | 178 mg/dL | 70â€“100 mg/dL | â¬†ï¸ High |\n| Creatinine | 1.4 mg/dL | 0.6â€“1.2 mg/dL | â¬†ï¸ High |\n| Hemoglobin | 10.2 g/dL | 12.0â€“15.5 g/dL (F) / 13.5â€“17.5 g/dL (M) | â¬‡ï¸ Low |\n\n### Glucose\nYour glucose is 178 mg/dL, which is higher than the usual fasting range. This can mean a few different things: it could be temporary (for example, if the sample was taken after eating or during stress), or it could be a sign of new or worsening problems with blood sugar control. This single result doesnâ€™t prove diabetes by itself. We recommend checking an HbA1c and a fasting glucose (or home glucose checks) to understand whether this is a longer-term issue.\n\n### Creatinine\nYour creatinine is slightly above the labâ€™s usual range. Creatinine helps estimate kidney function. A mild rise can happen with dehydration, certain medicines, or small changes in kidney function. We compare this to previous values and may repeat the test to see if itâ€™s a stable change or a new finding.\n\n### Hemoglobin\nYour hemoglobin is 10.2 g/dL, which is lower than expected and represents a notable drop from your prior tests (around 14â€“15 g/dL). A sudden fall like this can come from a few causes: recent blood loss, red blood cell breakdown (hemolysis), or less commonly a lab/sample error. Because this change was relatively large and happened quickly, itâ€™s important to re-check it right away and look for a cause.\n\nNext steps (what we recommend)\n- Repeat testing promptly: get a new, stat CBC to confirm the low hemoglobin and repeat creatinine and basic metabolic tests.  \n- If the low hemoglobin is confirmed: weâ€™ll order a hemolysis panel (reticulocyte count, peripheral smear, LDH, haptoglobin, bilirubin, and a direct Coombs test) and ask about any signs of bleeding or recent procedures.  \n- For glucose: get an HbA1c and a fasting glucose or start home glucose monitoring; follow-up with your primary care provider or endocrinology if needed.  \n- Review medications and hydration status; consider urinalysis and urine albumin/creatinine if kidney concern continues.  \n- Seek urgent care or the ER right away if you have symptoms like fainting, severe lightheadedness, ongoing bleeding, chest pain, shortness of breath, or very heavy urination and dehydration.\n\nIf youâ€™d like, I can help arrange the repeat tests or forward these results to your clinician for next steps.",
                "steps": [
                    {
                        "module": "Semantic Router",
                        "prompt": "Can you explain my blood test results?",
                        "response": "proposed_category=blood_test_analysis | score=1.0000 | confidence=high | passed=True | all_scores={'blood_test_analysis': 1.0, 'image_lesion_analysis': 0.3849, 'evidence_analyst': 0.5314}"
                    },
                    {
                        "module": "Manager Agent",
                        "prompt": "[SYSTEM]\nYou are the Manager Agent of an Autonomous Clinical System.\n\nYour core responsibilities depending on the current graph node:\n1. JUDGE NODE: Evaluate preliminary semantic routing decisions and definitively classify patient requests.\n2. DELIVERY NODE: Receive specialist analysis and reshape it into a clear, structured message for the patient.\n\nYou do NOT perform medical diagnosis or clinical analysis yourself. You orchestrate the workflow and handle the final communication.\n\n[USER]\nYou are the clinical triage manager of an autonomous medical AI system.\n\nA semantic router has analysed the patient's message and proposed a classification.\nYour job is to act as a Judge: review the proposal and either ACCEPT it or OVERRIDE it.\n\n---\nPATIENT MESSAGE:\n\"Can you explain my blood test results?\"\n\nROUTER PROPOSAL:\n- Proposed category : blood_test_analysis\n- Cosine similarity : 1.0000\n- Confidence band   : high\n---\n\nAVAILABLE CATEGORIES:\n- blood_test_analysis     â†’ patient is asking about lab results, blood test values, or specific medical metrics\n- image_lesion_analysis   â†’ patient uploaded or is describing a skin image, mole, lesion, or dermatological concern\n- evidence_analyst        â†’ patient is asking a general medical question about symptoms, conditions, or treatments\n- unsupported             â†’ request is non-medical or cannot be safely handled by this system\n\nYOUR TASK:\n1. Read the patient message carefully.\n2. Consider the router's proposal and confidence score.\n3. Determine the final routing category.\n\nCRITICAL INSTRUCTION: \nYou MUST call the `judge_decision` tool to return your answer. \nDO NOT write any plain text response. DO NOT greet the user. DO NOT explain your reasoning outside the tool. \nYour ONLY output must be the execution of the tool.\n\nRules for the tool:\n- If the router's proposal is correct, accept it by passing the same category.\n- If the router made a subtle mistake, pass the correct category instead.\n- Only use \"unsupported\" if the message is clearly non-medical.\n- Set overridden=True if you are changing the router's proposed category.",
                        "response": "[tool call triggered] {'accepted_category': 'blood_test_analysis', 'reasoning': 'The patient explicitly asks to have their blood test results explained, which directly matches the blood_test_analysis category.', 'overridden': False}"
                    },
                    {
                        "module": "Judge Decision",
                        "prompt": "accepted_category: blood_test_analysis\nreasoning: The patient explicitly asks to have their blood test results explained, which directly matches the blood_test_analysis category.\noverridden: False",
                        "response": "Routing to: blood_test_analyst | Accepted: blood_test_analysis | Overridden: False"
                    },
                    {
                        "module": "Blood Test Analyst",
                        "prompt": "[SYSTEM]\nYou are an expert medical research assistant analyzing laboratory test results.\n\nYour role is to gather comprehensive clinical information using the available tools to enable accurate diagnosis and recommendations.\n\nAvailable Tools:\n1. get_patient_history    - Retrieve patient demographics, chronic conditions, medications, lab history, and clinical notes\n2. check_reference_range  - Check ALL lab values at once â€” pass the full list of metrics in a single call\n3. search_medical_knowledge - Search medical literature for causes, conditions, diagnostic criteria, and treatment guidelines\n\nCRITICAL INSTRUCTIONS:\n1. ALWAYS call get_patient_history FIRST to get the patient's sex and age (required for reference range lookup)\n2. ALWAYS call check_reference_range ONCE with ALL metrics together in a single call â€” never call it one metric at a time\n   - Pass metrics as a list: [{{\"test_name\": \"Glucose\", \"value\": 178.0}}, {{\"test_name\": \"Creatinine\", \"value\": 1.4}}]\n   - Use the patient's sex and age from get_patient_history\n3. Call search_medical_knowledge AS MANY TIMES AS NEEDED:\n   - Search for causes of each abnormal value\n   - Search for diagnostic criteria and workup recommendations\n   - Search for treatment options\n   - Look for relationships between abnormal values (shared underlying cause)\n   - Continue searching until you have comprehensive information\n   - KEEP QUERIES SHORT â€” 2 to 5 words maximum\n     BAD:  \"diagnostic evaluation of elevated random glucose 178 mg/dL confirmatory tests HbA1c fasting\"\n     GOOD: \"glucose test results\"\n     GOOD: \"hemoglobin test results\"\n     \n\n4. After gathering ALL necessary information, you will be asked separately to provide a summary\n5. In this phase, focus ONLY on gathering complete information â€” summary will come later\n\nRemember: check_reference_range takes a LIST â€” one call covers all metrics.\n\n[USER]\n\nEXAMPLES OF THOROUGH CLINICAL REASONING:\n\nThe following examples demonstrate the depth of analysis expected. Study how each example:\n- Gathers patient context first (get_patient_history called ONCE)\n- Checks ALL reference ranges in a SINGLE call with the full metrics list\n- Searches medical knowledge as needed per finding\n\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nExample 1: Single Abnormal Metric\n\nLab Result: Patient P001 - Hemoglobin 9.8 g/dL (Flag: low)\n\nThought 1: I need patient history first to get sex/age for the reference range call, and to understand baseline.\nAction 1: get_patient_history[P001]\nObservation 1: Patient is Sarah Mitchell, 45yo female. Chronic conditions: Iron deficiency anemia. Recent notes: \"Vegetarian diet 11 months ago\", \"Heavy menstrual periods\", \"Iron supplementation 10 weeks, minimal improvement\". Hgb trend: 13.2 -> 9.8 g/dL over 18 months.\n\nThought 2: Now I call check_reference_range once with all metrics (just one here).\nAction 2: check_reference_range[metrics=[{\"test_name\": \"Hemoglobin\", \"value\": 9.8}], patient_sex=\"F\", patient_age=45]\nObservation 2: Hemoglobin 9.8 g/dL â€” Range: 12.0-15.5 g/dL â€” Status: abnormal_low â€” 18% below normal.\n\nThought 3: Clear anemia. Search for causes given vegetarian diet and menstrual loss.\nAction 3: search_medical_knowledge[iron deficiency anemia vegetarian women heavy menstruation]\nObservation 3: Iron deficiency anemia from insufficient heme iron intake + menstrual blood loss. Treatment: oral iron, or IV if unresponsive after 8-12 weeks.\n\nThought 4: Patient already on oral iron 10 weeks. Search IV iron criteria.\nAction 4: search_medical_knowledge[indications IV iron therapy oral iron failure]\nObservation 4: IV iron indicated when oral iron fails after 8-12 weeks, malabsorption, intolerance, or need for rapid repletion.\n\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nExample 2: Multiple Abnormal Metrics\n\nLab Results: Patient P002 â€” 2 abnormal metrics:\n  - Glucose: 178 mg/dL (Flag: high)\n  - Creatinine: 1.4 mg/dL (Flag: high)\n\nThought 1: Get patient history first for demographics and context.\nAction 1: get_patient_history[P002]\nObservation 1: Patient is John Doe, 58yo male. No chronic conditions. BMI 29. Notes: increased thirst, frequent urination, family history of type 2 diabetes.\n\nThought 2: Call check_reference_range ONCE with both metrics together.\nAction 2: check_reference_range[metrics=[{\"test_name\": \"Glucose\", \"value\": 178.0}, {\"test_name\": \"Creatinine\", \"value\": 1.4}], patient_sex=\"M\", patient_age=58]\nObservation 2:\n  - Glucose 178.0 mg/dL â€” Range: 70-100 mg/dL â€” Status: abnormal_high â€” 78% above normal\n  - Creatinine 1.4 mg/dL â€” Range: 0.7-1.3 mg/dL â€” Status: borderline_high â€” borderline\n\nThought 3: Both elevated â€” could be related (diabetes + early diabetic nephropathy). Search for this.\nAction 3: search_medical_knowledge[type 2 diabetes elevated glucose elevated creatinine kidney involvement]\nObservation 3: Persistent hyperglycemia causes diabetic nephropathy. Elevated creatinine in diabetics warrants renal function monitoring. HbA1c recommended to confirm chronic hyperglycemia.\n\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nKEY LESSONS:\n1. get_patient_history ONCE â€” gives you sex/age + clinical context\n2. check_reference_range ONCE â€” pass ALL metrics as a list\n3. Search for relationships between abnormal values â€” they may share a root cause\n\nYOUR TASK:\nApply the same approach to the patient case below.\n\nPATIENT CASE:\nLab Results: Patient P001 â€” 3 abnormal metrics:\n  - Glucose: 178 mg/dL (Flag: high)\n  - Creatinine: 1.4 mg/dL (Flag: high)\n  - Hemoglobin: 10.2 g/dL (Flag: low)\n\n",
                        "response": "[Tool Call Triggered: get_patient_history({'patient_id': 'P001'})]"
                    },
                    {
                        "module": "Get Patient History Data",
                        "prompt": "[TOOL ARGUMENTS]\n{'patient_id': 'P001'}",
                        "response": "Patient: Olivia Davis (48yo M)\n\nChronic Conditions:\nNone\n\nLab History (Hemoglobin trend):\n  2024-01-29: 14.4 g/dL (normal)\n  2024-05-07: 14.9 g/dL (normal)\n  2024-08-15: 14.6 g/dL (normal)\n  2024-11-17: 14.8 g/dL (normal)\n  2025-02-22: 14.7 g/dL (normal)\n  2025-05-23: 14.9 g/dL (normal)\n  2025-08-25: 14.3 g/dL (normal)\n  2026-02-20: 14.0 g/dL (normal)\n  2026-02-25: 10.2 g/dL (low)\n\nRecent Clinical Notes:\n  - 2025-08-25: Routine follow-up. Patient stable."
                    },
                    {
                        "module": "Blood Test Analyst",
                        "prompt": "[TOOL OBSERVATION]\nPatient: Olivia Davis (48yo M)\n\nChronic Conditions:\nNone\n\nLab History (Hemoglobin trend):\n  2024-01-29: 14.4 g/dL (normal)\n  2024-05-07: 14.9 g/dL (normal)\n  2024-08-15: 14.6 g/dL (normal)\n  2024-11-17: 14.8 g/dL (normal)\n  2025-02-22: 14.7 g/dL (normal)\n  2025-05-23: 14.9 g/dL (normal)\n  2025-08-25: 14.3 g/dL (normal)\n  2026-02-20: 14.0 g/dL (normal)\n  2026-02-25: 10.2 g/dL (low)\n\nRecent Clinical Notes:\n  - 2025-08-25: Routine follow-up. Patient stable.",
                        "response": "[Tool Call Triggered: check_reference_range({'metrics': [{'test_name': 'Glucose', 'value': 178.0}, {'test_name': 'Creatinine', 'value': 1.4}, {'test_name': 'Hemoglobin', 'value': 10.2}], 'patient_sex': 'M', 'patient_age': 48})]"
                    },
                    {
                        "module": "Check Reference Range",
                        "prompt": "[TOOL ARGUMENTS]\n{'metrics': [{'test_name': 'Glucose', 'value': 178.0}, {'test_name': 'Creatinine', 'value': 1.4}, {'test_name': 'Hemoglobin', 'value': 10.2}], 'patient_sex': 'M', 'patient_age': 48}",
                        "response": "Reference Range Results:\n  - Glucose = 178.0 mg/dL | Range: 70-100 mg/dL | Status: abnormal_high (abnormal) | Interpretation: Value is above normal range. Clinical evaluation recommended.\n  - Creatinine = 1.4 mg/dL | Range: 0.7-1.3 mg/dL | Status: borderline_high (borderline) | Interpretation: Value is slightly above normal range. May warrant monitoring.\n  - Hemoglobin = 10.2 g/dL | Range: 13.5-17.5 g/dL | Status: abnormal_low (abnormal) | Interpretation: Value is below normal range. Clinical evaluation recommended."
                    },
                    {
                        "module": "Blood Test Analyst",
                        "prompt": "[TOOL OBSERVATION]\nReference Range Results:\n  - Glucose = 178.0 mg/dL | Range: 70-100 mg/dL | Status: abnormal_high (abnormal) | Interpretation: Value is above normal range. Clinical evaluation recommended.\n  - Creatinine = 1.4 mg/dL | Range: 0.7-1.3 mg/dL | Status: borderline_high (borderline) | Interpretation: Value is slightly above normal range. May warrant monitoring.\n  - Hemoglobin = 10.2 g/dL | Range: 13.5-17.5 g/dL | Status: abnormal_low (abnormal) | Interpretation: Value is below normal range. Clinical evaluation recommended.",
                        "response": "[Tool Call Triggered: search_medical_knowledge({'query': 'acute drop hemoglobin causes'})]"
                    },
                    {
                        "module": "Search Medical Information",
                        "prompt": "[TOOL ARGUMENTS]\n{'query': 'acute drop hemoglobin causes'}",
                        "response": "Medical knowledge about 'acute drop hemoglobin causes': The provided context does not give a formal definition of an \"acute\" drop in hemoglobin, but it does list causes of low hemoglobin that can produce a rapid decrease. According to the sources:\n\n- Acute blood loss (can cause a sudden fall in hemoglobin), for example from injury or a heavy menstrual period (Source 1).  \n- Rapid red bloodâ€‘cell breakdown (hemolysis) â€” abnormal hemoglobins that make cells break down sooner can lead to anemia (Source 2).  \n- Other causes of low hemoglobin noted in the context (some more often producing subacute/chronic drops) include different types of anemia, thalassemia, iron deficiency, liver disease, cancer, and lack of nutrients such as vitamin Bâ€‘12 (Source 1).\n\nThe context does not provide a complete or detailed list of all acute causes (for example, it does not discuss transfusion reactions, certain infections, or some drugâ€‘induced hemolytic processes). For an acute drop in hemoglobin you should discuss your specific situation with a healthcare professional, who can evaluate for bleeding, hemolysis, boneâ€‘marrow problems, and other causes and recommend appropriate tests and treatment (as noted in the cited sources)."
                    },
                    {
                        "module": "Blood Test Analyst",
                        "prompt": "[TOOL OBSERVATION]\nKnowledge base answer:\nMedical knowledge about 'acute drop hemoglobin causes': The provided context does not give a formal definition of an \"acute\" drop in hemoglobin, but it does list causes of low hemoglobin that can produce a rapid decrease. According to the sources:\n\n- Acute blood loss (can cause a sudden fall in hemoglobin), for example from injury or a heavy menstrual period (Source 1).  \n- Rapid red bloodâ€‘cell breakdown (hemolysis) â€” abnormal hemoglobins that make cells break down sooner can lead to anemia (Source 2).  \n- Other causes of low hemoglobin noted in the context (some more often producing subacute/chronic drops) include different types of anemia, thalassemia, iron deficiency, liver disease, cancer, and lack of nutrients such as vitamin Bâ€‘12 (Source 1).\n\nThe context does not provide a complete or detailed list of all acute causes (for example, it does not discuss transfusion reactions, certain infections, or some drugâ€‘induced hemolytic processes). For an acute drop in hemoglobin you should discuss your specific situation with a healthcare professional, who can evaluate for bleeding, hemolysis, boneâ€‘marrow problems, and other causes and recommend appropriate tests and treatment (as noted in the cited sources).",
                        "response": "[Tool Call Triggered: search_medical_knowledge({'query': 'hyperglycemia causes and workup'})]"
                    },
                    {
                        "module": "Search Medical Information",
                        "prompt": "[TOOL ARGUMENTS]\n{'query': 'hyperglycemia causes and workup'}",
                        "response": "Medical knowledge about 'hyperglycemia causes and workup': Based only on the provided context:\n\nCauses of hyperglycemia\n- The most common causes are prediabetes and diabetes (type 1 or type 2), in which the body either canâ€™t make enough insulin or canâ€™t use insulin well, so too much glucose stays in the blood (According to Source 4).  \n- Other causes can include problems of the pancreas or adrenal glands and side effects of certain medicines (According to Source 2).  \n- If blood glucose isnâ€™t controlled, hyperglycemia can lead to long-term problems such as heart disease and nerve damage (According to Source 2 and Source 4).\n\nCommon symptoms suggesting high blood glucose\n- Increased thirst, frequent urination, blurred vision, fatigue, slowâ€‘healing sores, unintentional weight loss, and numbness or tingling in the feet or hands (According to Source 1).\n\nWorkup (tests a provider may order)\n- Several types of blood tests are used; your provider will choose the most appropriate test (According to Source 2).  \n- Hemoglobin A1C (HbA1c) â€” gives an average of blood glucose over the past ~3 months (According to Source 3).  \n- Oral glucose tolerance test (OGTT) â€” used to diagnose gestational diabetes and sometimes to confirm prediabetes or type 2 diabetes in nonpregnant people; requires fasting, with blood samples before and then about every hour for 2â€“3 hours after a sugary drink (According to Source 3).  \n- Glucose challenge test â€” used to screen for gestational diabetes (no fasting); you drink a sugary drink and a blood sample is taken one hour later; if high, an OGTT is usually done next (According to Source 3).  \n- General blood glucose testing (point-of-care or laboratory tests) can be used immediately when symptoms are present (implied in Source 3 and Source 4).\n\nLimitations of the provided context\n- The context does not give the numerical diagnostic thresholds (cutoff values) for hyperglycemia, nor specific treatment recommendations or management plans. For diagnosis, interpretation of test results, and treatment decisions you should consult a health care professional (Sources 2â€“4).\n\nNote: If you are concerned about symptoms or test results, talk with a health care provider for proper testing, diagnosis, and treatment."
                    },
                    {
                        "module": "Blood Test Analyst",
                        "prompt": "[TOOL OBSERVATION]\nKnowledge base answer:\nMedical knowledge about 'hyperglycemia causes and workup': Based only on the provided context:\n\nCauses of hyperglycemia\n- The most common causes are prediabetes and diabetes (type 1 or type 2), in which the body either canâ€™t make enough insulin or canâ€™t use insulin well, so too much glucose stays in the blood (According to Source 4).  \n- Other causes can include problems of the pancreas or adrenal glands and side effects of certain medicines (According to Source 2).  \n- If blood glucose isnâ€™t controlled, hyperglycemia can lead to long-term problems such as heart disease and nerve damage (According to Source 2 and Source 4).\n\nCommon symptoms suggesting high blood glucose\n- Increased thirst, frequent urination, blurred vision, fatigue, slowâ€‘healing sores, unintentional weight loss, and numbness or tingling in the feet or hands (According to Source 1).\n\nWorkup (tests a provider may order)\n- Several types of blood tests are used; your provider will choose the most appropriate test (According to Source 2).  \n- Hemoglobin A1C (HbA1c) â€” gives an average of blood glucose over the past ~3 months (According to Source 3).  \n- Oral glucose tolerance test (OGTT) â€” used to diagnose gestational diabetes and sometimes to confirm prediabetes or type 2 diabetes in nonpregnant people; requires fasting, with blood samples before and then about every hour for 2â€“3 hours after a sugary drink (According to Source 3).  \n- Glucose challenge test â€” used to screen for gestational diabetes (no fasting); you drink a sugary drink and a blood sample is taken one hour later; if high, an OGTT is usually done next (According to Source 3).  \n- General blood glucose testing (point-of-care or laboratory tests) can be used immediately when symptoms are present (implied in Source 3 and Source 4).\n\nLimitations of the provided context\n- The context does not give the numerical diagnostic thresholds (cutoff values) for hyperglycemia, nor specific treatment recommendations or management plans. For diagnosis, interpretation of test results, and treatment decisions you should consult a health care professional (Sources 2â€“4).\n\nNote: If you are concerned about symptoms or test results, talk with a health care provider for proper testing, diagnosis, and treatment.",
                        "response": "[Tool Call Triggered: search_medical_knowledge({'query': 'elevated creatinine causes and workup'})]"
                    },
                    {
                        "module": "Search Medical Information",
                        "prompt": "[TOOL ARGUMENTS]\n{'query': 'elevated creatinine causes and workup'}",
                        "response": "Medical knowledge about 'elevated creatinine causes and workup': I can summarize what the provided sources say about causes of an elevated creatinine level and how clinicians typically work it up.\n\nCauses of elevated creatinine (from the context)\n- Kidney problems that reduce filtration: kidney disease or injury, kidney infection, poor blood flow to the kidneys, a blockage in the urinary system, or kidney failure (Source 2). Conditions that affect the kidneys such as heart failure or diabetes are also listed (Source 2).  \n- Dehydration (Source 2).  \n- Muscle-related causes: muscle disorders or injuries, muscular dystrophy, intense exercise, or other conditions that cause rapid muscle breakdown (rhabdomyolysis) â€” which can release muscle proteins and harm the kidneys (Sources 2, 3, 4).  \n- Diet high in meat (Source 2).  \n- Certain health problems in pregnancy (Source 2).\n\nRelevant symptoms that often prompt testing (useful when evaluating elevated creatinine)\n- Swelling (hands/feet, puffy eyelids), changes in urination, foamy or bloody urine, fatigue, nausea/vomiting, shortness of breath, trouble thinking clearly, dry/itchy skin, muscle cramps, loss of appetite/weight loss, sleep problems (Source 1).\n\nTypical workup and interpretation steps (from the context)\n- Compare blood and urine creatinine and use calculations rather than raw creatinine alone: an estimated glomerular filtration rate (eGFR) is calculated using creatinine plus age, weight, height, and sex and gives a more accurate measure of kidney function than creatinine alone (Source 5).  \n- A creatinine clearance (blood vs. urine creatinine) can estimate how fast the kidneys filter waste; it may be useful in people with very high or very low muscle mass (Source 5).  \n- A urine albumin-to-creatinine ratio (UACR, aka microalbumin/creatinine ratio) may be measured to look for protein (albumin) loss in the urine, which helps assess kidney damage (Source 5).  \n- If muscle injury or rhabdomyolysis is suspected as the cause of high creatinine, creatine kinase (CK) testing may be used to assess muscle breakdown (Sources 3, 4).  \n- If results are unclear or abnormal, providers will interpret eGFR, creatinine clearance, and UACR to explain what they say about kidney health and determine next steps (Source 2, Source 5).\n\nLimitations and next steps\n- The above is what the provided sources describe. They also state that if your creatinine was used to calculate eGFR, creatinine clearance, or UACR, you should ask your provider to explain those measurements and what they mean for your kidney health (Source 2).  \n- For diagnosis and treatment decisions you should consult a healthcare professional.\n\nIf you want, tell me which results you have (blood creatinine number, eGFR, urine albumin/creatinine) and I can explain how the sources describe their interpretation; otherwise your clinician can interpret results in the context of your symptoms and medical history."
                    },
                    {
                        "module": "Blood Test Analyst",
                        "prompt": "[TOOL OBSERVATION]\nKnowledge base answer:\nMedical knowledge about 'elevated creatinine causes and workup': I can summarize what the provided sources say about causes of an elevated creatinine level and how clinicians typically work it up.\n\nCauses of elevated creatinine (from the context)\n- Kidney problems that reduce filtration: kidney disease or injury, kidney infection, poor blood flow to the kidneys, a blockage in the urinary system, or kidney failure (Source 2). Conditions that affect the kidneys such as heart failure or diabetes are also listed (Source 2).  \n- Dehydration (Source 2).  \n- Muscle-related causes: muscle disorders or injuries, muscular dystrophy, intense exercise, or other conditions that cause rapid muscle breakdown (rhabdomyolysis) â€” which can release muscle proteins and harm the kidneys (Sources 2, 3, 4).  \n- Diet high in meat (Source 2).  \n- Certain health problems in pregnancy (Source 2).\n\nRelevant symptoms that often prompt testing (useful when evaluating elevated creatinine)\n- Swelling (hands/feet, puffy eyelids), changes in urination, foamy or bloody urine, fatigue, nausea/vomiting, shortness of breath, trouble thinking clearly, dry/itchy skin, muscle cramps, loss of appetite/weight loss, sleep problems (Source 1).\n\nTypical workup and interpretation steps (from the context)\n- Compare blood and urine creatinine and use calculations rather than raw creatinine alone: an estimated glomerular filtration rate (eGFR) is calculated using creatinine plus age, weight, height, and sex and gives a more accurate measure of kidney function than creatinine alone (Source 5).  \n- A creatinine clearance (blood vs. urine creatinine) can estimate how fast the kidneys filter waste; it may be useful in people with very high or very low muscle mass (Source 5).  \n- A urine albumin-to-creatinine ratio (UACR, aka microalbumin/creatinine ratio) may be measured to look for protein (albumin) loss in the urine, which helps assess kidney damage (Source 5).  \n- If muscle injury or rhabdomyolysis is suspected as the cause of high creatinine, creatine kinase (CK) testing may be used to assess muscle breakdown (Sources 3, 4).  \n- If results are unclear or abnormal, providers will interpret eGFR, creatinine clearance, and UACR to explain what they say about kidney health and determine next steps (Source 2, Source 5).\n\nLimitations and next steps\n- The above is what the provided sources describe. They also state that if your creatinine was used to calculate eGFR, creatinine clearance, or UACR, you should ask your provider to explain those measurements and what they mean for your kidney health (Source 2).  \n- For diagnosis and treatment decisions you should consult a healthcare professional.\n\nIf you want, tell me which results you have (blood creatinine number, eGFR, urine albumin/creatinine) and I can explain how the sources describe their interpretation; otherwise your clinician can interpret results in the context of your symptoms and medical history.",
                        "response": "[Tool Call Triggered: search_medical_knowledge({'query': 'hemolysis causes workup reticulocyte peripheral smear haptoglobin bilirubin'})]"
                    },
                    {
                        "module": "Final Analysis",
                        "prompt": "[USER]\nYou are a medical analyst. Based on the following information gathered about a patient's lab results, provide a comprehensive clinical summary.\n\nPatient: P001\nLab Results: 3 abnormal metrics:\n  - Glucose: 178 mg/dL (Flag: high)\n  - Creatinine: 1.4 mg/dL (Flag: high)\n  - Hemoglobin: 10.2 g/dL (Flag: low)\n\nINFORMATION GATHERED:\n\n1. PATIENT HISTORY:\nPatient: Olivia Davis (48yo M)\n\nChronic Conditions:\nNone\n\nLab History (Hemoglobin trend):\n  2024-01-29: 14.4 g/dL (normal)\n  2024-05-07: 14.9 g/dL (normal)\n  2024-08-15: 14.6 g/dL (normal)\n  2024-11-17: 14.8 g/dL (normal)\n  2025-02-22: 14.7 g/dL (normal)\n  2025-05-23: 14.9 g/dL (normal)\n  2025-08-25: 14.3 g/dL (normal)\n  2026-02-20: 14.0 g/dL (normal)\n  2026-02-25: 10.2 g/dL (low)\n\nRecent Clinical Notes:\n  - 2025-08-25: Routine follow-up. Patient stable.\n\n\n2. REFERENCE RANGE CHECK:\nReference Range Results:\n  - Glucose = 178.0 mg/dL | Range: 70-100 mg/dL | Status: abnormal_high (abnormal) | Interpretation: Value is above normal range. Clinical evaluation recommended.\n  - Creatinine = 1.4 mg/dL | Range: 0.7-1.3 mg/dL | Status: borderline_high (borderline) | Interpretation: Value is slightly above normal range. May warrant monitoring.\n  - Hemoglobin = 10.2 g/dL | Range: 13.5-17.5 g/dL | Status: abnormal_low (abnormal) | Interpretation: Value is below normal range. Clinical evaluation recommended.\n\n\n3. MEDICAL KNOWLEDGE (3 searches):\n  [1] Knowledge base answer:\nMedical knowledge about 'acute drop hemoglobin causes': The provided context does not give a formal definition of an \"acute\" drop in hemoglobin, but it does list causes of low hemoglobin that can produce a rapid decrease. According to the sources:\n\n- Acute blood loss (can cause a sudden fall in hemoglobin), for example from injury or a heavy menstrual period (Source 1).  \n- Rapid red bloodâ€‘cell breakdown (hemolysis) â€” abnormal hemoglobins that make cells break down sooner can lead to anemia (Source 2).  \n- Other causes of low hemoglobin noted in the context (some more often producing subacute/chronic drops) include different types of anemia, thalassemia, iron deficiency, liver disease, cancer, and lack of nutrients such as vitamin Bâ€‘12 (Source 1).\n\nThe context does not provide a complete or detailed list of all acute causes (for example, it does not discuss transfusion reactions, certain infections, or some drugâ€‘induced hemolytic processes). For an acute drop in hemoglobin you should discuss your specific situation with a healthcare professional, who can evaluate for bleeding, hemolysis, boneâ€‘marrow problems, and other causes and recommend appropriate tests and treatment (as noted in the cited sources).\n\n  [2] Knowledge base answer:\nMedical knowledge about 'hyperglycemia causes and workup': Based only on the provided context:\n\nCauses of hyperglycemia\n- The most common causes are prediabetes and diabetes (type 1 or type 2), in which the body either canâ€™t make enough insulin or canâ€™t use insulin well, so too much glucose stays in the blood (According to Source 4).  \n- Other causes can include problems of the pancreas or adrenal glands and side effects of certain medicines (According to Source 2).  \n- If blood glucose isnâ€™t controlled, hyperglycemia can lead to long-term problems such as heart disease and nerve damage (According to Source 2 and Source 4).\n\nCommon symptoms suggesting high blood glucose\n- Increased thirst, frequent urination, blurred vision, fatigue, slowâ€‘healing sores, unintentional weight loss, and numbness or tingling in the feet or hands (According to Source 1).\n\nWorkup (tests a provider may order)\n- Several types of blood tests are used; your provider will choose the most appropriate test (According to Source 2).  \n- Hemoglobin A1C (HbA1c) â€” gives an average of blood glucose over the past ~3 months (According to Source 3).  \n- Oral glucose tolerance test (OGTT) â€” used to diagnose gestational diabetes and sometimes to confirm prediabetes or type 2 diabetes in nonpregnant people; requires fasting, with blood samples before and then about every hour for 2â€“3 hours after a sugary drink (According to Source 3).  \n- Glucose challenge test â€” used to screen for gestational diabetes (no fasting); you drink a sugary drink and a blood sample is taken one hour later; if high, an OGTT is usually done next (According to Source 3).  \n- General blood glucose testing (point-of-care or laboratory tests) can be used immediately when symptoms are present (implied in Source 3 and Source 4).\n\nLimitations of the provided context\n- The context does not give the numerical diagnostic thresholds (cutoff values) for hyperglycemia, nor specific treatment recommendations or management plans. For diagnosis, interpretation of test results, and treatment decisions you should consult a health care professional (Sources 2â€“4).\n\nNote: If you are concerned about symptoms or test results, talk with a health care provider for proper testing, diagnosis, and treatment.\n\n  [3] Knowledge base answer:\nMedical knowledge about 'elevated creatinine causes and workup': I can summarize what the provided sources say about causes of an elevated creatinine level and how clinicians typically work it up.\n\nCauses of elevated creatinine (from the context)\n- Kidney problems that reduce filtration: kidney disease or injury, kidney infection, poor blood flow to the kidneys, a blockage in the urinary system, or kidney failure (Source 2). Conditions that affect the kidneys such as heart failure or diabetes are also listed (Source 2).  \n- Dehydration (Source 2).  \n- Muscle-related causes: muscle disorders or injuries, muscular dystrophy, intense exercise, or other conditions that cause rapid muscle breakdown (rhabdomyolysis) â€” which can release muscle proteins and harm the kidneys (Sources 2, 3, 4).  \n- Diet high in meat (Source 2).  \n- Certain health problems in pregnancy (Source 2).\n\nRelevant symptoms that often prompt testing (useful when evaluating elevated creatinine)\n- Swelling (hands/feet, puffy eyelids), changes in urination, foamy or bloody urine, fatigue, nausea/vomiting, shortness of breath, trouble thinking clearly, dry/itchy skin, muscle cramps, loss of appetite/weight loss, sleep problems (Source 1).\n\nTypical workup and interpretation steps (from the context)\n- Compare blood and urine creatinine and use calculations rather than raw creatinine alone: an estimated glomerular filtration rate (eGFR) is calculated using creatinine plus age, weight, height, and sex and gives a more accurate measure of kidney function than creatinine alone (Source 5).  \n- A creatinine clearance (blood vs. urine creatinine) can estimate how fast the kidneys filter waste; it may be useful in people with very high or very low muscle mass (Source 5).  \n- A urine albumin-to-creatinine ratio (UACR, aka microalbumin/creatinine ratio) may be measured to look for protein (albumin) loss in the urine, which helps assess kidney damage (Source 5).  \n- If muscle injury or rhabdomyolysis is suspected as the cause of high creatinine, creatine kinase (CK) testing may be used to assess muscle breakdown (Sources 3, 4).  \n- If results are unclear or abnormal, providers will interpret eGFR, creatinine clearance, and UACR to explain what they say about kidney health and determine next steps (Source 2, Source 5).\n\nLimitations and next steps\n- The above is what the provided sources describe. They also state that if your creatinine was used to calculate eGFR, creatinine clearance, or UACR, you should ask your provider to explain those measurements and what they mean for your kidney health (Source 2).  \n- For diagnosis and treatment decisions you should consult a healthcare professional.\n\nIf you want, tell me which results you have (blood creatinine number, eGFR, urine albumin/creatinine) and I can explain how the sources describe their interpretation; otherwise your clinician can interpret results in the context of your symptoms and medical history.\n\nTASK: Synthesize the above information into a comprehensive clinical summary that includes:\n1. Status of each abnormal lab value (severity, clinical significance)\n2. Relevant patient history and trends\n3. Likely causes based on patient context\n4. Whether multiple abnormal values share a common underlying cause\n5. Recommended next steps\n\nProvide a clear, concise summary (2-4 paragraphs):",
                        "response": "Summary:\nThe most concerning result is the abrupt, moderate anemia: hemoglobin 10.2 g/dL (normal for adult male 13.5â€“17.5). This represents a large, acute fall from a long-standing baseline of ~14â€“15 g/dL on 2026â€‘02â€‘20 and prior years, making lab error, acute blood loss, or acute hemolysis the top considerations. Glucose 178 mg/dL is a mildâ€“moderate hyperglycemia (above normal fasting range but below the >200 mg/dL random threshold for a diabetes diagnosis without symptoms) and may represent new impaired glucose regulation, stress hyperglycemia, or an unfasted/random sample; follow-up testing is needed. Creatinine 1.4 mg/dL is slightly above the lab reference (0.7â€“1.3) and is borderline-elevated; its clinical significance depends on eGFR, prior creatinine baseline, hydration status, muscle mass, meds, and whether this is an acute change.\n\nInterpretation and likely causes:\nThe sudden fall in hemoglobin over days is most consistent with acute blood loss (occult GI bleeding, recent trauma/procedure, or less likely significant menstrual loss â€” not applicable if male), acute hemolysis, or a preanalytical/lab error (sample mix-up or dilution). Hemolysis workup (reticulocyte count, peripheral smear, LDH, haptoglobin, indirect bilirubin, direct antiglobulin test) and inquiry about bleeding symptoms/signs are high priority. The glucose elevation could reflect new diabetes/prediabetes (requires HbA1c and fasting glucose for diagnosis) or transient/stress hyperglycemia; if symptomatic (polyuria, polydipsia, weight loss) treat and evaluate sooner. The mild creatinine rise could reflect dehydration (may be related to hyperglycemia if osmotic diuresis is present), a true decline in kidney function, or a lab variation; it is not clearly severe but warrants follow-up.\n\nRecommended next steps:\n1) Urgent repeat testing to confirm the hemoglobin drop (stat CBC on a new sample) given the dramatic change from prior values. If confirmed, obtain reticulocyte count, peripheral smear, LDH, haptoglobin, bilirubin, and direct Coombs test to distinguish hemolysis vs blood loss; check coagulation panel and consider fecal occult blood testing and focused history/physical for bleeding sources (GI symptoms, melena, hematuria, recent procedures/trauma). If bleeding suspected, arrange GI evaluation (endoscopy) or urgent imaging as indicated.  \n2) Repeat BMP/serum creatinine and calculate eGFR; obtain urinalysis and urine albumin/creatinine ratio if kidney disease is a concern. Review medications and hydration; if creatinine rises or eGFR is reduced, consider nephrology input.  \n3) For glucose, obtain HbA1c and fasting plasma glucose (or home glucose logs) to characterize chronic vs acute hyperglycemia; counsel on symptoms and start home glucose monitoring if indicated and arrange outpatient follow-up with primary care or endocrinology.  \n4) If any urgent symptoms (lightheadedness, syncope, ongoing bleeding, chest pain, shortness of breath, marked polyuria/dehydration), advise emergency evaluation. Overall, prioritize confirming the hemoglobin result and rapidly distinguishing acute bleeding or hemolysis from lab error, while repeating and contextualizing the creatinine and glucose abnormalities."
                    },
                    {
                        "module": "Deliver Node",
                        "prompt": "[SYSTEM]\nYou are the Manager Agent of an Autonomous Clinical System.\n\nYour core responsibilities depending on the current graph node:\n1. JUDGE NODE: Evaluate preliminary semantic routing decisions and definitively classify patient requests.\n2. DELIVERY NODE: Receive specialist analysis and reshape it into a clear, structured message for the patient.\n\nYou do NOT perform medical diagnosis or clinical analysis yourself. You orchestrate the workflow and handle the final communication.\n\n[USER]\nYou are a medical assistant. \n\nPatient P001 has received blood test results.\n\nRAW RESULTS:\n| Glucose | 178 mg/dL | 70-100 mg/dL | â¬†ï¸ High |\n| Creatinine | 1.4 mg/dL | 0.6-1.2 mg/dL | â¬†ï¸ High |\n| Hemoglobin | 10.2 g/dL | 12.0-15.5 g/dL (F) / 13.5-17.5 g/dL (M) | â¬‡ï¸ Low |\n\nCLINICAL ANALYSIS:\nSummary:\nThe most concerning result is the abrupt, moderate anemia: hemoglobin 10.2 g/dL (normal for adult male 13.5â€“17.5). This represents a large, acute fall from a long-standing baseline of ~14â€“15 g/dL on 2026â€‘02â€‘20 and prior years, making lab error, acute blood loss, or acute hemolysis the top considerations. Glucose 178 mg/dL is a mildâ€“moderate hyperglycemia (above normal fasting range but below the >200 mg/dL random threshold for a diabetes diagnosis without symptoms) and may represent new impaired glucose regulation, stress hyperglycemia, or an unfasted/random sample; follow-up testing is needed. Creatinine 1.4 mg/dL is slightly above the lab reference (0.7â€“1.3) and is borderline-elevated; its clinical significance depends on eGFR, prior creatinine baseline, hydration status, muscle mass, meds, and whether this is an acute change.\n\nInterpretation and likely causes:\nThe sudden fall in hemoglobin over days is most consistent with acute blood loss (occult GI bleeding, recent trauma/procedure, or less likely significant menstrual loss â€” not applicable if male), acute hemolysis, or a preanalytical/lab error (sample mix-up or dilution). Hemolysis workup (reticulocyte count, peripheral smear, LDH, haptoglobin, indirect bilirubin, direct antiglobulin test) and inquiry about bleeding symptoms/signs are high priority. The glucose elevation could reflect new diabetes/prediabetes (requires HbA1c and fasting glucose for diagnosis) or transient/stress hyperglycemia; if symptomatic (polyuria, polydipsia, weight loss) treat and evaluate sooner. The mild creatinine rise could reflect dehydration (may be related to hyperglycemia if osmotic diuresis is present), a true decline in kidney function, or a lab variation; it is not clearly severe but warrants follow-up.\n\nRecommended next steps:\n1) Urgent repeat testing to confirm the hemoglobin drop (stat CBC on a new sample) given the dramatic change from prior values. If confirmed, obtain reticulocyte count, peripheral smear, LDH, haptoglobin, bilirubin, and direct Coombs test to distinguish hemolysis vs blood loss; check coagulation panel and consider fecal occult blood testing and focused history/physical for bleeding sources (GI symptoms, melena, hematuria, recent procedures/trauma). If bleeding suspected, arrange GI evaluation (endoscopy) or urgent imaging as indicated.  \n2) Repeat BMP/serum creatinine and calculate eGFR; obtain urinalysis and urine albumin/creatinine ratio if kidney disease is a concern. Review medications and hydration; if creatinine rises or eGFR is reduced, consider nephrology input.  \n3) For glucose, obtain HbA1c and fasting plasma glucose (or home glucose logs) to characterize chronic vs acute hyperglycemia; counsel on symptoms and start home glucose monitoring if indicated and arrange outpatient follow-up with primary care or endocrinology.  \n4) If any urgent symptoms (lightheadedness, syncope, ongoing bleeding, chest pain, shortness of breath, marked polyuria/dehydration), advise emergency evaluation. Overall, prioritize confirming the hemoglobin result and rapidly distinguishing acute bleeding or hemolysis from lab error, while repeating and contextualizing the creatinine and glucose abnormalities.\n\nWrite a patient-friendly message that:\n1. Starts with \"Hi! Your latest blood test results have arrived.\"\n2. Shows the results table\n3. Explains what each abnormal result means (use \"###\" headers for each test)\n4. Lists next steps\n\nKeep explanations simple and warm. Make it 300-500 words total.\n\nMessage:",
                        "response": "Hi! Your latest blood test results have arrived.\n\n| Test | Result | Reference range | Flag |\n| Glucose | 178 mg/dL | 70â€“100 mg/dL | â¬†ï¸ High |\n| Creatinine | 1.4 mg/dL | 0.6â€“1.2 mg/dL | â¬†ï¸ High |\n| Hemoglobin | 10.2 g/dL | 12.0â€“15.5 g/dL (F) / 13.5â€“17.5 g/dL (M) | â¬‡ï¸ Low |\n\n### Glucose\nYour glucose is 178 mg/dL, which is higher than the usual fasting range. This can mean a few different things: it could be temporary (for example, if the sample was taken after eating or during stress), or it could be a sign of new or worsening problems with blood sugar control. This single result doesnâ€™t prove diabetes by itself. We recommend checking an HbA1c and a fasting glucose (or home glucose checks) to understand whether this is a longer-term issue.\n\n### Creatinine\nYour creatinine is slightly above the labâ€™s usual range. Creatinine helps estimate kidney function. A mild rise can happen with dehydration, certain medicines, or small changes in kidney function. We compare this to previous values and may repeat the test to see if itâ€™s a stable change or a new finding.\n\n### Hemoglobin\nYour hemoglobin is 10.2 g/dL, which is lower than expected and represents a notable drop from your prior tests (around 14â€“15 g/dL). A sudden fall like this can come from a few causes: recent blood loss, red blood cell breakdown (hemolysis), or less commonly a lab/sample error. Because this change was relatively large and happened quickly, itâ€™s important to re-check it right away and look for a cause.\n\nNext steps (what we recommend)\n- Repeat testing promptly: get a new, stat CBC to confirm the low hemoglobin and repeat creatinine and basic metabolic tests.  \n- If the low hemoglobin is confirmed: weâ€™ll order a hemolysis panel (reticulocyte count, peripheral smear, LDH, haptoglobin, bilirubin, and a direct Coombs test) and ask about any signs of bleeding or recent procedures.  \n- For glucose: get an HbA1c and a fasting glucose or start home glucose monitoring; follow-up with your primary care provider or endocrinology if needed.  \n- Review medications and hydration status; consider urinalysis and urine albumin/creatinine if kidney concern continues.  \n- Seek urgent care or the ER right away if you have symptoms like fainting, severe lightheadedness, ongoing bleeding, chest pain, shortness of breath, or very heavy urination and dehydration.\n\nIf youâ€™d like, I can help arrange the repeat tests or forward these results to your clinician for next steps."
                    }
                ]
                },

            # Example 2 - Evidence Analyst
            {
                "prompt": "What is an allergy skin test?",
                "full_response": "Hi! I have some information regarding your medical question about allergy skin testing.\n\nWhat an allergy skin test is\n- Itâ€™s a way to check if your immune system overreacts to specific substances (allergens) by exposing a small area of skin and watching for a local reaction.\n- It mainly looks for immediate, IgEâ€‘mediated allergies (the kind that cause quick reactions) such as to pollens, dust mites, molds, pet dander, insect venom, some medicines, and household chemicals.\n\nHow the tests are done (simple overview)\n- Prick/scratch test: a tiny amount of allergen is placed on the skin and the surface is lightly pricked. A positive result usually looks like a small raised, red bump (called a wheal).\n- Intradermal test: a very small amount of allergen is injected just under the skin; this may be used if a prick test is negative but a doctor still suspects an allergy.\n- Patch test: adhesive patches with allergens are left on the skin for about 48â€“96 hours to check for delayed contact reactions (used for contact dermatitis).\n\nTiming\n- For prick or intradermal tests, a wheal usually appears within about 60â€“90 minutes.\n- Patch tests are read after being left in place for 48â€“96 hours.\n\nLimitations and safety\n- These tests mainly detect immediate (type I) allergic responses and wonâ€™t find all kinds of immune sensitivities.\n- Standard skin testing is not usually used to diagnose food allergies because larger exposures are needed and the risk of severe reactions is higher.\n- Local reactions (redness, swelling) at the test site are common. Severe reactions are rare, which is why testing is done in a controlled setting where clinicians can treat any reaction if needed.\n\nNext steps\n- Test results need to be interpreted together with your medical history and symptoms, so discuss them with your healthcare provider to decide on treatment or avoidance strategies.\n\nThis information is for educational purposes only and is not a substitute for personalized medical advice. Please consult your doctor or an allergy specialist to discuss whether testing is right for you and to interpret any results.",
                "steps": [
                    {
                        "module": "Semantic Router",
                        "prompt": "What is an allergy skin test?",
                        "response": "proposed_category=evidence_analyst | score=0.6253 | confidence=high | passed=True | all_scores={'blood_test_analysis': 0.2147, 'image_lesion_analysis': 0.3652, 'evidence_analyst': 0.6253}"
                    },
                    {
                        "module": "Manager Agent",
                        "prompt": "[SYSTEM]\nYou are the Manager Agent of an Autonomous Clinical System.\n\nYour core responsibilities depending on the current graph node:\n1. JUDGE NODE: Evaluate preliminary semantic routing decisions and definitively classify patient requests.\n2. DELIVERY NODE: Receive specialist analysis and reshape it into a clear, structured message for the patient.\n\nYou do NOT perform medical diagnosis or clinical analysis yourself. You orchestrate the workflow and handle the final communication.\n\n[USER]\nYou are the clinical triage manager of an autonomous medical AI system.\n\nA semantic router has analysed the patient's message and proposed a classification.\nYour job is to act as a Judge: review the proposal and either ACCEPT it or OVERRIDE it.\n\n---\nPATIENT MESSAGE:\n\"What is an allergy skin test?\"\n\nROUTER PROPOSAL:\n- Proposed category : evidence_analyst\n- Cosine similarity : 0.6253\n- Confidence band   : high\n---\n\nAVAILABLE CATEGORIES:\n- blood_test_analysis     â†’ patient is asking about lab results, blood test values, or specific medical metrics\n- image_lesion_analysis   â†’ patient uploaded or is describing a skin image, mole, lesion, or dermatological concern\n- evidence_analyst        â†’ patient is asking a general medical question about symptoms, conditions, or treatments\n- unsupported             â†’ request is non-medical or cannot be safely handled by this system\n\nYOUR TASK:\n1. Read the patient message carefully.\n2. Consider the router's proposal and confidence score.\n3. Determine the final routing category.\n\nCRITICAL INSTRUCTION: \nYou MUST call the `judge_decision` tool to return your answer. \nDO NOT write any plain text response. DO NOT greet the user. DO NOT explain your reasoning outside the tool. \nYour ONLY output must be the execution of the tool.\n\nRules for the tool:\n- If the router's proposal is correct, accept it by passing the same category.\n- If the router made a subtle mistake, pass the correct category instead.\n- Only use \"unsupported\" if the message is clearly non-medical.\n- Set overridden=True if you are changing the router's proposed category.",
                        "response": "[tool call triggered] {'accepted_category': 'evidence_analyst', 'reasoning': 'The patient asks a general medical question about a diagnostic procedure (allergy skin test), which fits the evidence_analyst category.', 'overridden': False}"
                    },
                    {
                        "module": "Judge Decision",
                        "prompt": "accepted_category: evidence_analyst\nreasoning: The patient asks a general medical question about a diagnostic procedure (allergy skin test), which fits the evidence_analyst category.\noverridden: False",
                        "response": "Routing to: evidence_analyst | Accepted: evidence_analyst | Overridden: False"
                    },
                    {
                        "module": "Evidence Analyst",
                        "prompt": "[SYSTEM]\nYou are an expert clinical evidence analyst ReAct agent.\nYour goal is to answer medical questions thoroughly and accurately based ONLY on the context you retrieve.\n\nYou have access to a RAG tool (`search_medical_knowledge`) that searches the MedlinePlus database. You are strictly limited to a MAXIMUM of 3 queries to this tool per user question.\n\nFollow this exact thought process for every query:\n1. Analyze the user's question and identify key medical terms.\n2. Use the `search_medical_knowledge` tool to fetch relevant clinical context.\n3. Analyze the returned context. Ask yourself: \"Do I have enough information to fully answer the question?\"\n4. If NO (and you have not yet reached your 3-query limit): Formulate a new, more specific, or alternative query and use the tool again.\n5. If YES: Synthesize the retrieved information into a comprehensive, clear, and medically accurate final answer.\n6. If you have reached your maximum of 3 queries and still cannot fully answer the question, honestly state that you do not have enough information in the database and provide the best partial answer you can based on what you *were* able to find.\n\nAlways base your final answer strictly on the tool's outputs. Do not guess or hallucinate medical information.\n\n---\nEXAMPLES OF YOUR REASONING PROCESS:\n\n**Example 1: Multi-step reasoning (Requires 2 queries)**\nUser: What are the common causes of anemia and how is it treated?\nThought: The user is asking for both causes and treatments of anemia. I will query for causes first.\nAction: Call `search_medical_knowledge` with query \"causes of anemia\".\nObservation: [Tool returns: \"Anemia is commonly caused by iron deficiency, vitamin B12 deficiency, and chronic diseases...\"]\nThought: I have the causes, but I still need treatments. I have used 1 out of 3 queries. I will query for treatments next.\nAction: Call `search_medical_knowledge` with query \"treatments for anemia\".\nObservation: [Tool returns: \"Treatment depends on the underlying cause, but often includes iron supplements, dietary changes, or in severe cases, blood transfusions.\"]\nThought: I now have enough information to answer both parts of the question. I have used 2 out of 3 queries. I will synthesize the final answer.\nFinal Answer: Anemia is primarily caused by deficiencies in iron or vitamin B12, as well as chronic diseases. Treatment is tailored to the specific cause and may involve iron supplements, adjusting your diet, or for severe cases, blood transfusions.\n\n**Example 2: Single-step success (Requires 1 query)**\nUser: What are the symptoms of strep throat?\nThought: The user is asking for a specific list of symptoms for a single condition. One query should be sufficient.\nAction: Call `search_medical_knowledge` with query \"symptoms of strep throat\".\nObservation: [Tool returns: \"Symptoms of strep throat include a sudden, severe sore throat, pain when swallowing, fever, swollen tonsils, and swollen lymph nodes in the front of the neck.\"]\nThought: I have a complete list of symptoms from the database. I have used 1 out of 3 queries. I can formulate the final answer now.\nFinal Answer: The common symptoms of strep throat include a sudden and severe sore throat, pain during swallowing, fever, swollen tonsils, and swollen lymph nodes in the front of your neck.\n\n**Example 3: Reaching the query limit (Fails to find complete info)**\nUser: What is the exact genetic mutation sequence for the rare disease fictionalitis?\nThought: The user is asking for specific genetic data on a disease. I will search for it.\nAction: Call `search_medical_knowledge` with query \"fictionalitis genetic mutation sequence\".\nObservation: [Tool returns: \"No results found for fictionalitis.\"]\nThought: The direct search failed. I have used 1 out of 3 queries. I will try searching just the disease name.\nAction: Call `search_medical_knowledge` with query \"fictionalitis\".\nObservation: [Tool returns: \"No results found for fictionalitis in MedlinePlus.\"]\nThought: Still no results. I have used 2 out of 3 queries. I'll try a broader search for rare genetic diseases to see if it's an alternate name.\nAction: Call `search_medical_knowledge` with query \"rare genetic diseases\".\nObservation: [Tool returns: \"List of rare diseases: Fabry disease, Familial Mediterranean fever... (Fictionalitis is not listed).\"]\nThought: I have used my maximum of 3 queries and cannot find the information in the database. I must inform the user honestly.\nFinal Answer: I apologize, but after searching the MedlinePlus database, I could not find any information regarding a disease called \"fictionalitis\" or its genetic mutation sequence. \n\n\n[USER]\nWhat is an allergy skin test?",
                        "response": "[Tool Call Triggered: search_medical_knowledge({'query': 'allergy skin test'})]"
                    },
                    {
                        "module": "Search Medical Information",
                        "prompt": "[TOOL ARGUMENTS]\n{'query': 'allergy skin test'}",
                        "response": "Medical knowledge about 'allergy skin test': Hereâ€™s a summary of what an allergy skin test is, how itâ€™s done, what it checks for, and important limitations based only on the provided sources.\n\nWhat an allergy skin test is\n- An allergy skin test exposes your skin to suspected allergens to see if your immune system overreacts (an allergic reaction). This usually checks for Type 1 hypersensitivity reactions (common allergies such as pollens, dust mites, molds, pet dander) but not all immune overreactions are Type 1 (Sources 2, 3, 4).\n\nTypes of skin tests and what happens\n- Prick/scratch (puncture) and intradermal tests: a tiny amount of allergen is placed on or just under the skin. For intradermal testing, a small amount of allergen is injected just below the skin with a very thin needle; if you are allergic you typically develop a hive or small red bump (a wheal) at the site within about 60â€“90 minutes. Intradermal testing may be used when a scratch/prick test is negative but allergy is still suspected (Source 5).\n- Patch test: small patches that look like adhesive bandages, containing small amounts of specific allergens, are placed on the skin and left in place. You are asked to avoid getting the area wet and to wear the patches for about 48 to 96 hours; your provider then removes them and checks for rashes or contact dermatitis (Sources 1, 5).\n\nWhat allergens can be tested\n- Typical allergens tested include pollen, dust mites, molds, pet dander, insect venoms, medicines, and household chemicals (Source 3).\n\nImportant limitations and safety\n- Food allergies are not tested with this skin-test method because testing would require larger amounts of allergen and raises the risk of severe reactions such as anaphylactic shock (Source 5).\n- The test primarily detects Type 1 hypersensitivity reactions; other types of immune overreactions exist and may not be identified by these tests (Source 3).\n- Symptoms of allergic reactions can range from mild (sneezing, runny/stuffy nose) to severe (anaphylactic shock) (Source 4).\n\nOther names\n- The tests are also called type 1 hypersensitivity skin test, hypersensitivity test, allergy scratch test, allergy patch test, intradermal test, prick test, or puncture test (Source 2).\n\nIf you need diagnosis or treatment\n- This information describes the tests only. For interpretation of results, diagnosis, or treatment decisions, consult a healthcare professional (Sources 1â€“5)."
                    },
                    {
                        "module": "Analyze and Report",
                        "prompt": "[TOOL OBSERVATION]\nMedical knowledge about 'allergy skin test': Hereâ€™s a summary of what an allergy skin test is, how itâ€™s done, what it checks for, and important limitations based only on the provided sources.\n\nWhat an allergy skin test is\n- An allergy skin test exposes your skin to suspected allergens to see if your immune system overreacts (an allergic reaction). This usually checks for Type 1 hypersensitivity reactions (common allergies such as pollens, dust mites, molds, pet dander) but not all immune overreactions are Type 1 (Sources 2, 3, 4).\n\nTypes of skin tests and what happens\n- Prick/scratch (puncture) and intradermal tests: a tiny amount of allergen is placed on or just under the skin. For intradermal testing, a small amount of allergen is injected just below the skin with a very thin needle; if you are allergic you typically develop a hive or small red bump (a wheal) at the site within about 60â€“90 minutes. Intradermal testing may be used when a scratch/prick test is negative but allergy is still suspected (Source 5).\n- Patch test: small patches that look like adhesive bandages, containing small amounts of specific allergens, are placed on the skin and left in place. You are asked to avoid getting the area wet and to wear the patches for about 48 to 96 hours; your provider then removes them and checks for rashes or contact dermatitis (Sources 1, 5).\n\nWhat allergens can be tested\n- Typical allergens tested include pollen, dust mites, molds, pet dander, insect venoms, medicines, and household chemicals (Source 3).\n\nImportant limitations and safety\n- Food allergies are not tested with this skin-test method because testing would require larger amounts of allergen and raises the risk of severe reactions such as anaphylactic shock (Source 5).\n- The test primarily detects Type 1 hypersensitivity reactions; other types of immune overreactions exist and may not be identified by these tests (Source 3).\n- Symptoms of allergic reactions can range from mild (sneezing, runny/stuffy nose) to severe (anaphylactic shock) (Source 4).\n\nOther names\n- The tests are also called type 1 hypersensitivity skin test, hypersensitivity test, allergy scratch test, allergy patch test, intradermal test, prick test, or puncture test (Source 2).\n\nIf you need diagnosis or treatment\n- This information describes the tests only. For interpretation of results, diagnosis, or treatment decisions, consult a healthcare professional (Sources 1â€“5).",
                        "response": "An allergy skin test is a way to check whether your immune system overreacts to specific substances (allergens) by exposing a small area of skin to those substances and watching for a local allergic reaction.\n\nKey points\n- Purpose: Detects IgE-mediated (type 1 hypersensitivity) allergies such as to pollens, dust mites, molds, pet dander, insect venom, some medicines, and household chemicals.\n- How itâ€™s done:\n  - Prick/scratch (puncture) test: a tiny amount of allergen is placed on the skin and the surface is lightly pricked. A positive reaction usually produces a raised, red bump (wheal) at the site.\n  - Intradermal test: a small amount of allergen is injected just under the skin with a very thin needle; used when a prick test is negative but suspicion remains.\n  - Patch test: adhesive patches containing allergens are placed on the skin for about 48â€“96 hours to check for contact (delayed) dermatitis.\n- Timing: For prick or intradermal tests, a wheal typically appears within about 60â€“90 minutes. Patch tests are read after being left in place for 48â€“96 hours.\n- What it does not do / limitations:\n  - Primarily detects immediate (type 1) allergic responses; it wonâ€™t find all immune-related sensitivities.\n  - Standard skin testing is generally not used to test for food allergies because larger exposures would be needed and there is greater risk of severe reactions (including anaphylaxis).\n- Safety: Reactions at the test site are common (local swelling, redness). Severe allergic reactions are rare but possible; testing is done in a controlled setting so clinicians can treat reactions if they occur.\n- Other names: allergy scratch test, prick test, intradermal test, patch test, hypersensitivity skin test.\n\nFor interpretation of results and decisions about treatment or avoidance, consult a healthcare professionalâ€”results must be considered together with your history and symptoms."
                    },
                    {
                        "module": "Deliver Node",
                        "prompt": "[SYSTEM]\nYou are the Manager Agent of an Autonomous Clinical System.\n\nYour core responsibilities depending on the current graph node:\n1. JUDGE NODE: Evaluate preliminary semantic routing decisions and definitively classify patient requests.\n2. DELIVERY NODE: Receive specialist analysis and reshape it into a clear, structured message for the patient.\n\nYou do NOT perform medical diagnosis or clinical analysis yourself. You orchestrate the workflow and handle the final communication.\n\n[USER]\nYou are a medical assistant answering a patient's clinical question.\n\nPatient API_USER asked a medical question and our Evidence AI found the following information from trusted medical databases:\n\nCLINICAL EVIDENCE:\nAn allergy skin test is a way to check whether your immune system overreacts to specific substances (allergens) by exposing a small area of skin to those substances and watching for a local allergic reaction.\n\nKey points\n- Purpose: Detects IgE-mediated (type 1 hypersensitivity) allergies such as to pollens, dust mites, molds, pet dander, insect venom, some medicines, and household chemicals.\n- How itâ€™s done:\n  - Prick/scratch (puncture) test: a tiny amount of allergen is placed on the skin and the surface is lightly pricked. A positive reaction usually produces a raised, red bump (wheal) at the site.\n  - Intradermal test: a small amount of allergen is injected just under the skin with a very thin needle; used when a prick test is negative but suspicion remains.\n  - Patch test: adhesive patches containing allergens are placed on the skin for about 48â€“96 hours to check for contact (delayed) dermatitis.\n- Timing: For prick or intradermal tests, a wheal typically appears within about 60â€“90 minutes. Patch tests are read after being left in place for 48â€“96 hours.\n- What it does not do / limitations:\n  - Primarily detects immediate (type 1) allergic responses; it wonâ€™t find all immune-related sensitivities.\n  - Standard skin testing is generally not used to test for food allergies because larger exposures would be needed and there is greater risk of severe reactions (including anaphylaxis).\n- Safety: Reactions at the test site are common (local swelling, redness). Severe allergic reactions are rare but possible; testing is done in a controlled setting so clinicians can treat reactions if they occur.\n- Other names: allergy scratch test, prick test, intradermal test, patch test, hypersensitivity skin test.\n\nFor interpretation of results and decisions about treatment or avoidance, consult a healthcare professionalâ€”results must be considered together with your history and symptoms.\n\nWrite a patient-friendly message that:\n1. Starts warmly (e.g., \"Hi! I have some information regarding your medical question.\")\n2. Summarizes the clinical evidence clearly and simply.\n3. Avoids overly dense medical jargon.\n4. Includes a disclaimer that this information is for educational purposes and they should consult their doctor for personalized medical advice.\n\nMessage:",
                        "response": "Hi! I have some information regarding your medical question about allergy skin testing.\n\nWhat an allergy skin test is\n- Itâ€™s a way to check if your immune system overreacts to specific substances (allergens) by exposing a small area of skin and watching for a local reaction.\n- It mainly looks for immediate, IgEâ€‘mediated allergies (the kind that cause quick reactions) such as to pollens, dust mites, molds, pet dander, insect venom, some medicines, and household chemicals.\n\nHow the tests are done (simple overview)\n- Prick/scratch test: a tiny amount of allergen is placed on the skin and the surface is lightly pricked. A positive result usually looks like a small raised, red bump (called a wheal).\n- Intradermal test: a very small amount of allergen is injected just under the skin; this may be used if a prick test is negative but a doctor still suspects an allergy.\n- Patch test: adhesive patches with allergens are left on the skin for about 48â€“96 hours to check for delayed contact reactions (used for contact dermatitis).\n\nTiming\n- For prick or intradermal tests, a wheal usually appears within about 60â€“90 minutes.\n- Patch tests are read after being left in place for 48â€“96 hours.\n\nLimitations and safety\n- These tests mainly detect immediate (type I) allergic responses and wonâ€™t find all kinds of immune sensitivities.\n- Standard skin testing is not usually used to diagnose food allergies because larger exposures are needed and the risk of severe reactions is higher.\n- Local reactions (redness, swelling) at the test site are common. Severe reactions are rare, which is why testing is done in a controlled setting where clinicians can treat any reaction if needed.\n\nNext steps\n- Test results need to be interpreted together with your medical history and symptoms, so discuss them with your healthcare provider to decide on treatment or avoidance strategies.\n\nThis information is for educational purposes only and is not a substitute for personalized medical advice. Please consult your doctor or an allergy specialist to discuss whether testing is right for you and to interpret any results."
                    }
                ]
            },
            # Example 3 - Skin Lesuire
            {
                "prompt": "Can you analyze this skin lesion?",
                "full_response": "## Greeting\nHi! We've completed the preliminary analysis of your skin lesion image.\n\n## AI Screening Results\n- **What we detected**: benign mole-like lesion  \n- **Urgency level**: Low Urgency  \n- **AI confidence**: 97.2%\n\n## What does this mean?\nThis finding most often represents a common, non-dangerous mole that does not usually change quickly. It was classified as Low Urgency because the image did not show features that suggest an immediate concern. Stay calmâ€”this is a screening result, not a diagnosis.\n\n## What should you do next?\n- Schedule a routine dermatologist check-up in the next 2â€“4 weeks.  \n- Monitor the lesion for any changes in size, color, shape, border, elevation, bleeding, itching, or new symptoms. Take clear, dated photos with consistent lighting and a ruler or coin for scale every 1â€“2 months to compare over time and bring them to your appointment.  \n- Mention this AI screening to your dermatologist so they have the image and the screening context.  \n- No im	mediate emergency is indicated, but professional evaluation is recommended to confirm the finding.\n\n## Important Reminder\n\"This AI screening is a preliminary assessment tool, not a medical diagnosis. Only a board-certified dermatologist can provide an accurate diagnosis through in-person examination. If you notice rapid changes, bleeding, or other concerning symptoms, seek medical attention immediately regardless of this screening result.\"\n\nIf youâ€™d like, I can help you schedule a follow-up or send the image and the screening summary to your dermatologist.",
                "steps": [
                    {
                        "module": "Semantic Router",
                        "prompt": "Can you analyze this skin lesion?",
                        "response": "proposed_category=image_lesion_analysis | score=0.7353 | confidence=high | passed=True | all_scores={'blood_test_analysis': 0.3681, 'image_lesion_analysis': 0.7353, 'evidence_analyst': 0.2063}"
                    },
                    {
                        "module": "Manager Agent",
                        "prompt": "[SYSTEM]\nYou are the Manager Agent of an Autonomous Clinical System.\n\nYour core responsibilities depending on the current graph node:\n1. JUDGE NODE: Evaluate preliminary semantic routing decisions and definitively classify patient requests.\n2. DELIVERY NODE: Receive specialist analysis and reshape it into a clear, structured message for the patient.\n\nYou do NOT perform medical diagnosis or clinical analysis yourself. You orchestrate the workflow and handle the final communication.\n\n[USER]\nYou are the clinical triage manager of an autonomous medical AI system.\n\nA semantic router has analysed the patient's message and proposed a classification.\nYour job is to act as a Judge: review the proposal and either ACCEPT it or OVERRIDE it.\n\n---\nPATIENT MESSAGE:\n\"Can you analyze this skin lesion?\"\n\nROUTER PROPOSAL:\n- Proposed category : image_lesion_analysis\n- Cosine similarity : 0.7353\n- Confidence band   : high\n---\n\nAVAILABLE CATEGORIES:\n- blood_test_analysis     â†’ patient is asking about lab results, blood test values, or specific medical metrics\n- image_lesion_analysis   â†’ patient uploaded or is describing a skin image, mole, lesion, or dermatological concern\n- evidence_analyst        â†’ patient is asking a general medical question about symptoms, conditions, or treatments\n- unsupported             â†’ request is non-medical or cannot be safely handled by this system\n\nYOUR TASK:\n1. Read the patient message carefully.\n2. Consider the router's proposal and confidence score.\n3. Determine the final routing category.\n\nCRITICAL INSTRUCTION: \nYou MUST call the `judge_decision` tool to return your answer. \nDO NOT write any plain text response. DO NOT greet the user. DO NOT explain your reasoning outside the tool. \nYour ONLY output must be the execution of the tool.\n\nRules for the tool:\n- If the router's proposal is correct, accept it by passing the same category.\n- If the router made a subtle mistake, pass the correct category instead.\n- Only use \"unsupported\" if the message is clearly non-medical.\n- Set overridden=True if you are changing the router's proposed category.",
                        "response": "[tool call triggered] {'accepted_category': 'image_lesion_analysis', 'reasoning': 'The user explicitly asks for analysis of a skin lesion, which matches the image_lesion_analysis category.', 'overridden': False}"
                    },
                    {
                        "module": "Judge Decision",
                        "prompt": "accepted_category: image_lesion_analysis\nreasoning: The user explicitly asks for analysis of a skin lesion, which matches the image_lesion_analysis category.\noverridden: False",
                        "response": "Routing to: skin_care_analyst | Accepted: image_lesion_analysis | Overridden: False"
                    },
                    {
                        "module": "Classify Skin Lesion",
                        "prompt": "tool: classify_skin_lesion\nargs: image_path=C:\\Users\\razbi\\PycharmProjects\\AutonomousClinicalSystem\\backend\\agents\\skin_care_analyst\\demo_data\\ISIC_0024500.jpg",
                        "response": "label=Low Urgency | finding=nevus (benign mole) | conf=0.9717 | bbox=[226.30752563476562, 152.76101684570312, 379.7075500488281, 328.3179016113281]"
                    },
                    {
                        "module": "Analyze and Report",
                        "prompt": "You are a dermatology clinical assistant. Below is the output from an AI skin lesion detection model for patient API_USER.\n\nMODEL RESULTS:\n- Urgency Classification: Low Urgency\n- Clinical Finding: nevus (benign mole)\n- Confidence Level: 97.2%\n- Detection Location: Bounding box coordinates [226.3, 152.8, 379.7, 328.3]\n\nGenerate a structured clinical summary with these sections:\n\n**SECTION 1: DETECTION SUMMARY**\nState what the model detected and the confidence level in 1-2 sentences.\n\n**SECTION 2: CLINICAL SIGNIFICANCE**\nExplain what \"nevus (benign mole)\" means in clinical terms (2-3 sentences):\n- What type of lesion this typically represents\n- Why the urgency classification is \"Low Urgency\"\n- Any relevant clinical context\n\n**SECTION 3: RECOMMENDED ACTIONS**\nBased on urgency level, provide specific recommendations:\n- If \"High Urgency\": Emphasize need for immediate dermatologist evaluation (within 24-48 hours)\n- If \"Low Urgency\": Recommend routine dermatologist check-up for confirmation\n- Suggest monitoring for changes (size, color, shape, symptoms)\n- Mention documentation (photos over time)\n\n**SECTION 4: LIMITATIONS**\nClearly state:\n- This is a preliminary AI screening, NOT a diagnosis\n- Only a dermatologist can provide definitive diagnosis\n- The model has limitations and cannot replace professional examination\n\nKeep language precise but accessible. Use 150-200 words total.\n\nClinical Summary:",
                        "response": "**SECTION 1: DETECTION SUMMARY**\nThe model detected a nevus (benign mole) at bounding box [226.3, 152.8, 379.7, 328.3] with high confidence (97.2%). Urgency was classified as Low Urgency.\n\n**SECTION 2: CLINICAL SIGNIFICANCE**\nA nevus is typically a common benign melanocytic lesion (mole) that is usually stable in size, shape, and color. Low urgency indicates no immediate signs suggestive of malignancy on image-based screening. Clinical context matters: changes in appearance, symptoms (bleeding, itching, pain), or a personal/family history of skin cancer would raise concern.\n\n**SECTION 3: RECOMMENDED ACTIONS**\nFor Low Urgency: arrange a routine dermatology appointment for clinical confirmation (for example within 4â€“8 weeks or at your next regular skin check). Monitor the lesion for changes in size, color, shape, border irregularity, elevation, bleeding, itching, or new symptoms. Take clear dated photos with consistent lighting and a ruler or coin for scale every 1â€“2 months to document changes and bring them to your appointment.\n\n**SECTION 4: LIMITATIONS**\nThis is a preliminary AI screening, not a diagnosis. Only a dermatologist, with in-person examination and possibly biopsy, can provide a definitive diagnosis. The model has limitations and cannot replace professional clinical evaluation."
                    },
                    {
                        "module": "Deliver Node",
                        "prompt": "[SYSTEM]\nYou are the Manager Agent of an Autonomous Clinical System.\n\nYour core responsibilities depending on the current graph node:\n1. JUDGE NODE: Evaluate preliminary semantic routing decisions and definitively classify patient requests.\n2. DELIVERY NODE: Receive specialist analysis and reshape it into a clear, structured message for the patient.\n\nYou do NOT perform medical diagnosis or clinical analysis yourself. You orchestrate the workflow and handle the final communication.\n\n[USER]\nYou are a patient care coordinator specializing in dermatology screening results.\n\nA dermatology AI has analyzed a skin lesion image for patient API_USER.\n\nCLINICAL ANALYSIS FROM SPECIALIST:\n**SECTION 1: DETECTION SUMMARY**\nThe model detected a nevus (benign mole) at bounding box [226.3, 152.8, 379.7, 328.3] with high confidence (97.2%). Urgency was classified as Low Urgency.\n\n**SECTION 2: CLINICAL SIGNIFICANCE**\nA nevus is typically a common benign melanocytic lesion (mole) that is usually stable in size, shape, and color. Low urgency indicates no immediate signs suggestive of malignancy on image-based screening. Clinical context matters: changes in appearance, symptoms (bleeding, itching, pain), or a personal/family history of skin cancer would raise concern.\n\n**SECTION 3: RECOMMENDED ACTIONS**\nFor Low Urgency: arrange a routine dermatology appointment for clinical confirmation (for example within 4â€“8 weeks or at your next regular skin check). Monitor the lesion for changes in size, color, shape, border irregularity, elevation, bleeding, itching, or new symptoms. Take clear dated photos with consistent lighting and a ruler or coin for scale every 1â€“2 months to document changes and bring them to your appointment.\n\n**SECTION 4: LIMITATIONS**\nThis is a preliminary AI screening, not a diagnosis. Only a dermatologist, with in-person examination and possibly biopsy, can provide a definitive diagnosis. The model has limitations and cannot replace professional clinical evaluation.\n\nCreate a warm, structured patient message with these EXACT sections:\n\n## Greeting\nStart with: \"Hi! We've completed the preliminary analysis of your skin lesion image.\"\n\n## AI Screening Results\nPresent in a simple format:\n- **What we detected**: [finding type in plain language]\n- **Urgency level**: [High Urgency or Low Urgency]\n- **AI confidence**: [percentage]\n\n## What does this mean?\nExplain in 2-3 sentences:\n- What this type of lesion typically is (avoid medical jargon)\n- Why it's classified at this urgency level\n- Keep calm and factual\n\n## What should you do next?\nProvide clear action items based on urgency:\n\n**If High Urgency:**\n- **Schedule a dermatologist appointment within 24-48 hours**\n- Mention this is a preliminary AI screening that needs professional confirmation\n- Bring the image with you to the appointment\n- Note any changes in size, color, or symptoms\n\n**If Low Urgency:**\n- Schedule a routine dermatologist check-up in the next 2-4 weeks\n- Monitor for any changes (take photos for comparison)\n- Mention the AI screening to your dermatologist\n- No immediate emergency, but professional evaluation is recommended\n\n## Important Reminder\nAdd this disclaimer:\n\"This AI screening is a preliminary assessment tool, not a medical diagnosis. Only a board-certified dermatologist can provide an accurate diagnosis through in-person examination. If you notice rapid changes, bleeding, or other concerning symptoms, seek medical attention immediately regardless of this screening result.\"\n\n---\n\n**Tone guidelines:**\n- Be warm and reassuring, not alarming\n- Use simple language (avoid terms like \"melanoma\" or \"nevus\" - say \"concerning skin change\" or \"benign mole-like lesion\")\n- For High Urgency: Be serious and directive without causing panic\n- For Low Urgency: Be calm but still emphasize importance of professional check-up\n- Keep total length 250-350 words\n\nPatient message:",
                        "response": "## Greeting\nHi! We've completed the preliminary analysis of your skin lesion image.\n\n## AI Screening Results\n- **What we detected**: benign mole-like lesion  \n- **Urgency level**: Low Urgency  \n- **AI confidence**: 97.2%\n\n## What does this mean?\nThis finding most often represents a common, non-dangerous mole that does not usually change quickly. It was classified as Low Urgency because the image did not show features that suggest an immediate concern. Stay calmâ€”this is a screening result, not a diagnosis.\n\n## What should you do next?\n- Schedule a routine dermatologist check-up in the next 2â€“4 weeks.  \n- Monitor the lesion for any changes in size, color, shape, border, elevation, bleeding, itching, or new symptoms. Take clear, dated photos with consistent lighting and a ruler or coin for scale every 1â€“2 months to compare over time and bring them to your appointment.  \n- Mention this AI screening to your dermatologist so they have the image and the screening context.  \n- No immediate emergency is indicated, but professional evaluation is recommended to confirm the finding.\n\n## Important Reminder\n\"This AI screening is a preliminary assessment tool, not a medical diagnosis. Only a board-certified dermatologist can provide an accurate diagnosis through in-person examination. If you notice rapid changes, bleeding, or other concerning symptoms, seek medical attention immediately regardless of this screening result.\"\n\nIf youâ€™d like, I can help you schedule a follow-up or send the image and the screening summary to your dermatologist."
                    }
                ]
            }

                ]
        })




# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# C)  GET /api/model_architecture
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

@app.get("/api/model_architecture")
async def model_architecture():
    """
    Return the system architecture as a PNG image.
    Generated in memory by matplotlib â€” no static file needed.
    """
    try:
        from backend.architecture_diagram import generate_architecture_png
        png_bytes = generate_architecture_png()
        return Response(content=png_bytes, media_type="image/png")
    except Exception as e:
        log.exception("model_architecture: failed to generate PNG")
        raise HTTPException(status_code=500, detail=f"Diagram generation failed: {e}")


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# D)  POST /api/execute
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

@app.post("/api/execute")
async def execute(body: ExecuteRequest):
    """
    Main pipeline entry point.

    Accepts a plain-text medical prompt, runs the full multi-agent pipeline,
    and returns the patient-friendly response + a structured step trace.

    Pipeline:
        SemanticRouter â†’ ManagerAgent/Judge â†’ Specialist â†’ DeliverNode
    """
    user_prompt = body.prompt.strip()

    if not user_prompt:
        return JSONResponse(content={
            "status":   "error",
            "error":    "Prompt must not be empty.",
            "response": None,
            "steps":    [],
        }, status_code=400)

    steps: list[dict] = []

    try:
        # â”€â”€ Step 1: Semantic routing â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        route_result      = route_request(user_prompt)
        proposed_category = route_result["category"]
        router_score      = route_result["score"]
        router_confidence = route_result["confidence"]
        passed            = route_result["passed"]

        # â”€â”€ Spam gate â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        if not passed:
            steps.append({
                "module": "Semantic Router",
                "prompt": {
                    "text":   user_prompt,
                    "method": "cosine_similarity",
                },
                "response": {
                    "proposed_category": "unmatched",
                    "score":             router_score,
                    "confidence":        "spam",
                    "passed":            False,
                },
            })
            return JSONResponse(content={
                "status":   "ok",
                "error":    None,
                "response": (
                    "I'm sorry, I can only assist with medical questions. "
                    "Please describe a health concern, lab result, or symptom."
                ),
                "steps": steps,
            })

        # â”€â”€ Build state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # For blood test analysis the API uses the first available patient's
        # most recent lab results from Supabase as a demonstration dataset.
        # For skin care analysis the demo image is used automatically by
        # run_skin_care_analyst when image_path is None.
        patient_id = "API_USER"

        if proposed_category == "blood_test_analysis":
            try:
                from backend.agents.graph import analyze_existing_test

                patients = get_patients_summary()
                if patients:
                    patient_id = patients[0]["id"]
                    lab_state  = analyze_existing_test(patient_id, -1)
                    lab_result = lab_state.get("lab_result", [])
                else:
                    lab_result = []
            except Exception:
                lab_result = []

            initial_state = build_blood_test_state(
                user_text         = user_prompt,
                proposed_category = proposed_category,
                router_score      = router_score,
                router_confidence = router_confidence,
                patient_id        = patient_id,
                lab_result        = lab_result,
            )

        elif proposed_category == "image_lesion_analysis":
            # No image upload in the API â€” run_skin_care_analyst falls back
            # to the bundled demo image automatically when image_path is None.
            initial_state = {
                "request_type":             proposed_category,
                "patient_id":               patient_id,
                "raw_user_input":           user_prompt,
                "router_proposed_category": proposed_category,
                "router_score":             router_score,
                "router_confidence":        router_confidence,
                "lab_result":               None,
                "lab_insights":             None,
                "image_path":               None,   # triggers demo fallback
                "vision_results":           None,
                "vision_insights":          None,
                "evidence_insights":        None,
                "messages":                 [],
                "next_step":                "",
                "final_report":             None,
                "steps":                    [],
            }

        else:  # evidence_analyst
            initial_state = build_evidence_state(
                user_text         = user_prompt,
                proposed_category = proposed_category,
                router_score      = router_score,
                router_confidence = router_confidence,
                patient_id        = patient_id,
            )

        # â”€â”€ Execute full pipeline â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        final_state  = execute_pipeline(initial_state)
        final_report = final_state.get("final_report") or ""

        # â”€â”€ Build structured steps â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        steps = _build_steps_from_state(route_result, user_prompt, final_state)

        return JSONResponse(content={
            "status":   "ok",
            "error":    None,
            "response": final_report,
            "steps":    steps,
        })

    except Exception as exc:
        log.exception("execute: pipeline failed")
        return JSONResponse(
            status_code=500,
            content={
                "status":   "error",
                "error":    str(exc),
                "response": None,
                "steps":    steps,  # return whatever steps were captured so far
            },
        )